# =====================================================
# Archivo .htaccess para el Sistema CDA
# 
# INSTRUCCIONES:
# 1. Copia este archivo y renómbralo a '.htaccess'
# 2. Ajusta las configuraciones según tu servidor
# 3. Asegúrate de que tu servidor Apache tenga mod_rewrite habilitado
# =====================================================

# Habilitar mod_rewrite
RewriteEngine On

# =====================================================
# SEGURIDAD - PROTEGER ARCHIVOS SENSIBLES
# =====================================================

# Bloquear acceso a archivos de configuración
<Files "config.php">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.env">
    Order Allow,Deny
    Deny from all
</Files>

# Bloquear acceso a archivos de log
<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

# Bloquear acceso a archivos de backup
<Files "*.bak">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.sql">
    Order Allow,Deny
    Deny from all
</Files>

# Bloquear acceso a archivos de instalación después de la instalación
<Files "install.php">
    Order Allow,Deny
    Deny from all
</Files>

# =====================================================
# PROTECCIÓN CONTRA ATAQUES COMUNES
# =====================================================

# Deshabilitar listado de directorios
Options -Indexes

# Ocultar información del servidor
ServerTokens Prod
ServerSignature Off

# Proteger contra ataques XSS
<IfModule mod_headers.c>
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# =====================================================
# COMPRESIÓN Y CACHÉ
# =====================================================

# Comprimir archivos
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Configurar caché para archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# =====================================================
# REGLAS DE REWRITE PARA URLS AMIGABLES
# =====================================================

# Redirigir www a no-www (opcional)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

# Redirigir HTTP a HTTPS (descomenta si tienes SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# =====================================================
# MANEJO DE ERRORES
# =====================================================

# Página de error 404 personalizada
ErrorDocument 404 /siscda/404.php

# Página de error 500 personalizada
ErrorDocument 500 /siscda/500.php

# Página de error 403 personalizada
ErrorDocument 403 /siscda/403.php

# =====================================================
# LIMITACIONES DE TAMAÑO DE ARCHIVOS
# =====================================================

# Limitar tamaño de subida de archivos (ajusta según necesites)
php_value upload_max_filesize 10M
php_value post_max_size 10M
php_value max_execution_time 300
php_value max_input_time 300

# =====================================================
# PROTECCIÓN CONTRA BOTS MALICIOSOS
# =====================================================

# Bloquear user agents maliciosos
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget).* [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^.*(libwww-perl|curl|wget|python|nikto|wkito|pikto|acunetix).* [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^.*(winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner).* [NC]
RewriteRule .* - [F,L]

# =====================================================
# CONFIGURACIONES ESPECÍFICAS DEL SISTEMA
# =====================================================

# Permitir acceso solo a archivos PHP específicos en el directorio raíz
<FilesMatch "^(index|login|logout|install)\.php$">
    Order Allow,Deny
    Allow from all
</FilesMatch>

# Bloquear acceso a archivos PHP en directorios de módulos si no están autenticados
<FilesMatch "\.php$">
    <RequireAll>
        Require all granted
        # Aquí puedes agregar lógica adicional de autenticación si es necesario
    </RequireAll>
</FilesMatch>

# =====================================================
# FIN DEL ARCHIVO .HTACCESS
# =====================================================
